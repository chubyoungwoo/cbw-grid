<template>
  <div style="margin: 20px; margin-right: 50px">
    <br />
    <div
      style="
        margin-left: 50px;
        background-color: aliceblue;
        font-size: x-large;
        font-family: emoji;
        border-radius: 20px;
        padding-left: 50px;
      "
    >
      <div>
        <span style="margin-left: 50px">GridTable</span>
      </div>
    </div>

    <br />
    <BeeGridTable
      ref="table"
      border
      :showSummary="false"
      :summary-method="customSummary"
      :columns="columns"
      :data="data"
      height="720"
      @on-row-click="onRowClick"
    >
      <template slot-scope="{ row }" slot="sex">
        <i style="font-size: x-large" class="bee-sys-icon md-man" v-if="row.sex === 0"></i>
        <i style="font-size: x-large; color: red" class="bee-sys-icon md-woman" v-else></i>
      </template>
      <template slot-scope="{ column, doSortAndFilter }" slot="fsex">
        <RadioGroup
          v-model="column.selectedSexCode"
          @on-change="sexSelected(column, doSortAndFilter)"
        >
          <Radio label="-1">
            <i class="bee-sys-icon md-people"></i>
            <span>전체</span>
          </Radio>
          <Radio label="0">
            <i class="bee-sys-icon md-man"></i>
            <span>남성</span>
          </Radio>
          <Radio label="1">
            <i style="color: red" class="bee-sys-icon md-woman"></i>
            <span>여성</span>
          </Radio>
        </RadioGroup>
      </template>
      <template slot="hop">
        <Button type="primary" size="large" @click="exportData()">엑셀다운</Button>
      </template>

      <template slot-scope="{ row, index }" slot="op">
        <Button
          type="warning"
          size="small"
          style="margin-right: 5px"
          @click="handleModify(row, index)"
        >수정</Button>
        <Button type="error" size="small" @click="handleDelete(row, index)">삭제</Button>
      </template>
    </BeeGridTable>
  </div>
</template>
<script>
import BeeGridTable from '../components/table/table.vue';
import Radio from '../components/radio/radio.vue';
import RadioGroup from '../components/radio/radio-group.vue';
import Button from '../components/button/button.vue';

export default {
    components: { BeeGridTable, RadioGroup, Radio, Button },
    data() {
        return {
            columns: [
                {
                    title: '성명',
                    key: 'name',
                    align: 'center',
                    width: 200,
                    filterHeight: 50,
                    resizable: true,
                    fixed: 'left',
                    filterMethod(column, field, value, row) {
                        if (
                            value === undefined ||
                            value === null ||
                            value === ''
                        ) {
                            return true;
                        }
                        return row.name.search(value) !== -1;
                    }
                },
                {
                    title: '정보',
                    align: 'center',
                    children: [
                        {
                            title: 'Salary',
                            key: 'salary',
                            showSummary: true,
                            align: 'center',
                            width: 200,
                            sortable: true
                        },
                        {
                            title: '주소',
                            align: 'center',
                            children: [
                                {
                                    title: '도로명',
                                    key: 'street',
                                    align: 'center',
                                    width: 200,
                                    hideFilter: true,
                                    resizable: true
                                },
                                {
                                    title: '블럭',
                                    align: 'center',
                                    children: [
                                        {
                                            title: '건물',
                                            key: 'building',
                                            align: 'center',
                                            width: 300,
                                            sortable: true,
                                            sortType: 'desc'
                                        },
                                        {
                                            title: '건물번호',
                                            key: 'door',
                                            align: 'center',
                                            width: 300
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    title: '업체',
                    align: 'center',
                    children: [
                        {
                            title: '주소',
                            key: 'caddress',
                            align: 'center',
                            width: 200
                        },
                        {
                            title: '업체명',
                            key: 'cname',
                            align: 'center',
                            width: 200
                        }
                    ]
                },
                {
                    title: '성별',
                    key: 'sex',
                    align: 'center',
                    width: 200,
                    filterHeight: 50,
                    fixed: 'right',
                    resizable: true,
                    slot: 'sex',
                    selectedSexCode: -1,
                    headFilterSlot: 'fsex'
                },
                {
                    title: '슬롯',
                    key: 'op',
                    slot: 'op',
                    headSlot: 'hop',
                    align: 'center',
                    width: 200,
                    hideFilter: true,
                    filterHeight: 50,
                    fixed: 'right',
                    resizable: true
                }
            ],

            data: []
        };
    },
    methods: {
        handleResize(width) {},
        handleSpan({ row, column, rowIndex, columnIndex }) {
            if (rowIndex % 2 === 0) {
                if (columnIndex === 0) {
                    return [1, 2];
                } else if (columnIndex === 1) {
                    return [0, 0];
                }
            }
        },
        handleModify(row, index) {
            console.log('수정', row, index);
        },
        handleDelete(row, index) {
            console.log('삭제', row, index);
        },
        onRowClick(row, index) {
            //  console.log(row, index);
        },
        exportData() {
            this.$refs.table.exportCsv({
                filename: 'GridTable'
            });
        },
        sexSelected(column, doSortAndFilter) {
            console.log('column.selectedSexCode', column.selectedSexCode);

            column.filterValue =
                column.selectedSexCode === '-1' ? null : column.selectedSexCode;
            doSortAndFilter();
        },
        //사용자정의 합계
        customSummary({ columns, data }) {
            const sums = {};
            let doorNum = 0;
            columns.forEach((column, index) => {
                const key = column.key;
                if (column.key === 'name') {
                    sums[column.key] = {
                        key: column.key,
                        value: '합계'
                    };
                    return;
                }
                // 통계salary
                if (column.key === 'salary') {
                    const values = data.map(item => Number(item[key]));
                    if (!values.every(value => isNaN(value))) {
                        const v = values.reduce((prev, curr) => {
                            const value = Number(curr);
                            if (!isNaN(value)) {
                                return prev + curr;
                            } else {
                                return prev;
                            }
                        }, 0);
                        sums[key] = {
                            key,
                            value: v + ' 원'
                        };
                    } else {
                        sums[key] = {
                            key,
                            value: 'N/A'
                        };
                    }
                }

                //건물번호
                if (column.key === 'door') {
                    const values = data.map(item => Number(item[key]));
                    values.reduce((prev, curr) => {
                        if (doorNum < curr) {
                            doorNum = curr;
                        }
                        return doorNum;
                    }, 0);
                }
            });
            /*
            sums['door'] = {
                key: 'door',
                value: doorNum + ' 번호'
            };
            */
            return sums;
        },
        handleSpan2({ row, column, rowIndex, columnIndex }) {
            if (columnIndex === 0) {
                if (rowIndex % 2 === 0) {
                    return {
                        rowspan: 2,
                        colspan: 1
                    };
                } else {
                    return {
                        rowspan: 0,
                        colspan: 0
                    };
                }
            }
        }
    },
    mounted() {
        setTimeout(() => {
            let tempData = [];
            for (var i = 1; i < 1001; i++) {
                tempData.push({
                    key: i,
                    name: '테스트' + i,
                    salary: i,
                    street: '오송생명 5로',
                    building: 'A' + i,
                    door: i % 21,
                    caddress: '경기도 안양시...',
                    cname: '(주)인포벨리코리아',
                    sex: i % 2
                });
            }
            this.data = tempData;
        }, 1000);
    }
};
</script>
